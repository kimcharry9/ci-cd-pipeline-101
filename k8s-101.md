# Odoo-Report-101
-  This document will be writen based on "Odoo Backup Weekly Report" laboratory tasks.

[Table Of Contents] - [Odoo-Report-101](#odoo-report-101)
- [Odoo-Report-101](#odoo-report-101)
  - [1. Install PostgreSQL *-NEEDS-*](#1-install-postgresql--needs-)
  - [2. Install Odoo with adding repository](#2-install-odoo-with-adding-repository)
  - [3. Install AWS S3 CLI](#3-install-aws-s3-cli)
  - [4. Configure AWS S3 credentials](#4-configure-aws-s3-credentials)
  - [5. Test AWS S3 command by listing object on the specified bucket](#5-test-aws-s3-command-by-listing-object-on-the-specified-bucket)
  - [6. Create script for purposed](#6-create-script-for-purposed)
    - [6.1) Create 'generate report' script](#61-create-generate-report-script)
    - [6.2) Create 'send report to email' script](#62-create-send-report-to-email-script)
    - [6.3) Create 'main' script for including workflow script](#63-create-main-script-for-including-workflow-script)
  - [7. Create k8s cronjob for purposed](#7-create-k8s-cronjob-for-purposed)
    - [7.1) Create secrets for aws-cli and smtp connection](#71-create-secrets-for-aws-cli-and-smtp-connection)
    - [7.2) Create cronjob deployment via .yaml file including configmap section](#72-create-cronjob-deployment-via-yaml-file-including-configmap-section)
    - [7.3) Deploy cronjob via command](#73-deploy-cronjob-via-command)
    - [7.4) \[Optional\] k8s useful command](#74-optional-k8s-useful-command)


## 1. Install PostgreSQL *-NEEDS-*
```shell
sudo apt install postgresql -y
```

## 2. Install Odoo with adding repository
```shell
 wget -q -O - https://nightly.odoo.com/odoo.key | sudo gpg --dearmor -o /usr/share/keyrings/odoo-archive-keyring.gpg
 echo 'deb [signed-by=/usr/share/keyrings/odoo-archive-keyring.gpg] https://nightly.odoo.com/19.0/nightly/deb/ ./' | sudo tee /etc/apt/sources.list.d/odoo.list
 sudo apt-get update && sudo apt-get install odoo
```

## 3. Install AWS S3 CLI
```shell
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /

which aws
aws --version
```

## 4. Configure AWS S3 credentials
```shell
aws configure --profile <profile_name>

AWS Access Key ID [None]: <your_AK>
AWS Secret Access Key [None]: <your_SK>
Default region name [None]: <your_region e.g. ap-southeast-1>
Default output format [None]: json
```

## 5. Test AWS S3 command by listing object on the specified bucket
```shell
aws s3 ls --profile <profile_name> --human-readable s3://<bucket_name>/<folder>/
```

## 6. Create script for purposed
### 6.1) Create 'generate report' script
```shell
#!/bin/bash

# Receive config file to replace variables
#source $1

CURRENT_DIR_TIMESTAMP=`date +"%Y-%m-%d_%H:%M:%S"`
echo "Executing Date: ${CURRENT_DIR_TIMESTAMP}"
echo ""

# Information collecting
OBJECT_LIST=`aws s3 ls --profile ${S3_PROFILE_NAME}  \
                s3://${S3_BUCKET_NAME}/${S3_FOLDER_NAME}/    \
                | grep '.zip$' | awk -v d="$(date -d "${LATEST_MODIFIED_DATE} days ago" +"%Y-%m-%d")" '$1 > d'`
OBJECT_DATE=(`echo "${OBJECT_LIST}" | awk '{printf "%s ", $1}'`)
OBJECT_SIZE=(`echo "${OBJECT_LIST}" | awk '{printf "%s ", $3}'`)
OBJECT_FILE_NAME=(`echo "${OBJECT_LIST}" | awk '{printf "%s ", $4}'`)

# Main script
echo "[1] List odoo backup files last 7 days:"
echo "${OBJECT_LIST}"
echo ""

echo "[2] Check lost backup file:"
is_found=0
for day in {6..0}
do
  current_day_check=`date -d "${day} days ago" +"%Y-%m-%d"`
  file_name_index="$((6-day))"
  if [[ ! "${OBJECT_DATE[@]}" =~ "${current_day_check}" ]]
  then
    echo "> [CRITICAL] MISSING file on date '${current_day_check}'"
  else
    is_found=`echo "${is_found}+1" | bc`
    #echo "> [INFO] Found the file '${OBJECT_FILE_NAME[$file_name_index]}' on date '${current_day_check}'"
  fi
done

if [[ "${is_found}" == "7" ]]
then
  echo "> [INFO] Found ALL backup files."
fi
echo ""

echo "[3] Check weekly file size:"
sum_bytes=0
for bytes in ${OBJECT_SIZE[@]}
do
  sum_bytes=`echo "scale=2; ${sum_bytes}+${bytes}" | bc`
done
printf "> Total weekly backup size = %.2f GB.\n" "`echo "scale=2; ${sum_bytes}/1024/1024/1024" | bc`"

echo ""
```
### 6.2) Create 'send report to email' script
```shell
#!/bin/bash

{
  echo "From: noreply-test <${MAIL_FROM}>"
  echo "To: ${MAIL_TO}"
  echo "Subject: [`date +"%Y-%m-%d"`] ${MAIL_SUBJECT}"
  echo "MIME-Version: 1.0"
  echo "Content-Type: text/html; charset=UTF-8"
  echo
  echo "<html>"
  echo "<body style='font-family: Arial, sans-serif;'>" 
  echo "<p><strong>Dear Team,</strong></p>"
  echo "<p> </p>"
  echo "<p>This is email to inform you about <strong>'${MAIL_SUBJECT}'</strong>.
  <br/>For this week, please validate the information with cares below.</p>"
  
  echo "<pre style='background:#f6f6f6; padding:10px; font-family: monospace; white-space: pre-wrap;'>"
  cat odoo-backup-report.txt
  echo "</pre>"

  echo "<p><strong>Best Regards,</strong><br/>System Team</p>"

  echo "</body>"
  echo "</html>"

} | msmtp -t
```

### 6.3) Create 'main' script for including workflow script
```shell
#!/bin/bash

WORK_DIR=`pwd`

# 1. Generate report
${WORK_DIR}/report-generator-script.sh > ${WORK_DIR}/odoo-backup-report.txt

# 2. Send report to email
${WORK_DIR}/send-report-to-mail-script.sh
rm -f ${WORK_DIR}/odoo-backup-report.txt
```

## 7. Create k8s cronjob for purposed
### 7.1) Create secrets for aws-cli and smtp connection
```shell
kubectl create secret generic k8s-secret-<project-name> -n <k8s-namespace> \
  --from-file=credentials="${HOME}/.aws/credentials" \
  --from-file=.msmtprc=".msmtprc"
```

### 7.2) Create cronjob deployment via .yaml file including configmap section
```shell
apiVersion: v1
kind: ConfigMap
metadata:
  name: k8s-configmap-<project-name>
  namespace: <k8s-namespace>
data:
  # replaced "<...>" with your information
  S3_PROFILE_NAME: "<S3_PROFILE_NAME>"
  S3_BUCKET_NAME: "<S3_BUCKET_NAME>"
  S3_FOLDER_NAME: "<S3_FOLDER_NAME>"
  LATEST_MODIFIED_DATE: "<DAYS>"
  MAIL_FROM: "<MAIL_FROM>"
  MAIL_TO: "<MAIL_TO>"
  MAIL_SUBJECT: "<MAIL_SUBJECT>"

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: k8s-cronjob-<project-name>
  namespace: <k8s-namespace>
spec:
  schedule: "*/2 * * * *"
  #concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          volumes:
            - name: secret-files
              secret:
                secretName: k8s-secret-<project-name>
                defaultMode: 0600
          containers:
            - name: container-<project-name>-0-0-2
              image: wongsatorn/<project-name>:0.0.2
              imagePullPolicy: IfNotPresent
              envFrom:
                - configMapRef:
                    name: k8s-configmap-<project-name>
              volumeMounts:
                # AWS S3 Credentials
                - name: secret-files
                  mountPath: /root/.aws/credentials
                  subPath: credentials
                  readOnly: true
                # SFTP Credentials by .msmtp device
                - name: secret-files
                  mountPath: /root/.msmtprc
                  subPath: .msmtprc
                  readOnly: true
```
### 7.3) Deploy cronjob via command
```shell
kubectl apply -f <your-yaml-file>.yaml

# can possible run with 'create' command for fresh-start deployment.
# if deployment is already exist. please use 'apply' instead.
kubectl create -f <your-yaml-file>.yaml
```
### 7.4) [Optional] k8s useful command
- explain component of yaml file
```shell
kubectl explain --api-version="batch/v1" cronjobs.spec
```